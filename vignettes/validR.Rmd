---
title: "validR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{validR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The validR is a set of functions to be used for testing and validating data. 
The main functions are:

- **test_range**: tests if column values are within a certain range
- **test_values**: tests if column values are certain categories
- **test_unique**: tests column values are unique
- **test_na**: tests column values don't contain NAs
- **test_test_orphan_rec**: tests if merge between primary and related table doesn't result in any orphaned keys

To use the testing functions first create the test setup. How each test class should be setup can be found by ?setup_test_range in the details section.

- setup_test_range
- setup_test_values
- setup_test_unique
- setup_test_na
- setup_test_orphan_rec

## Column Tests

```{r, eval = FALSE, echo = TRUE}

library(validR)

df <- data.frame(w = c(NA, 2:10),
                 x = 1:10, 
                 y = c(rep("X", 4), rep("Y", 4), rep("Z", 2)),
                 z = c(1,1,3:10), 
                 stringsAsFactors = F)

# Setup the test classes

setup_range1 <- setup_test_range(df_name = "df", col_name = "x", int = TRUE, lower_inclu = TRUE,
                                  upper_inclu = TRUE, lower = 1, upper = 10, na = FALSE)
setup_range2 <- setup_test_range(df_name = "df", col_name = "z", int = TRUE, lower_inclu = TRUE,
                                  upper_inclu = TRUE, lower = 3, upper = 10, na = FALSE)
setup_range3 <- setup_test_range(df_name = "df", col_name = "w", int = TRUE, lower_inclu = FALSE,
                                  upper_inclu = NULL, lower = 2, upper = NULL, na = TRUE)
setup_range <- list(setup_range1, setup_range2, setup_range3)

setup_values1 <- setup_test_values(df_name = "df", col_name = "y", values = c("X"), na = FALSE)
setup_values <- list(setup_values1)

setup_unique1 <- setup_test_unique(df_name = "df", col_name = "x", na = FALSE)
setup_unique2 <- setup_test_unique(df_name = "df", col_name = "z", na = FALSE)
setup_unique <- list(setup_unique1, setup_unique2)

setup_na1 <- setup_test_na(df_name = "df", col_name = "y")
setup_na2 <- setup_test_na(df_name = "df", col_name = "w")
setup_na <- list(setup_na1, setup_na2)

setup <- c(setup_range, setup_values, setup_unique, setup_na)

# If the tests all rely on the same dataframe use the following line of code to apply the tests

col_tests <- do.call("rbind", lapply(setup, test_summary, df = df))

na_problems <- do.call("rbind", lapply(setup_na, get_problems, df = df))
unique_problems <- do.call("rbind", lapply(setup_unique, get_problems, df = df))
range_problems <- do.call("rbind", lapply(setup_range, get_problems, df = df))
values_problems <- do.call("rbind", lapply(setup_values, get_problems, df = df))

```

## Merge Tests

```{r}

library(validR)

primary_df <- data.frame(id1 = c(1,2,2,3), id2 = c(1,1,2,1), y = c(1,1,2,5))
related_df <- data.frame(id1 = c(1,2,3), id2 = c(1,1,1), x = c(1,2,3))

setup1 <- setup_test_orphan_rec(primary_df = "df1", related_df = "df2", 
                               primary_key = c("id1", "id2"), foreign_key = c("id1", "id2"))

test1 <- test_summary(setup1, primary_df, related_df)
problems1 <- get_problems(setup1, primary_df, related_df)


primary_df <- data.frame(id = c(1,2,2), id2 = c(1,1,2), y = c(1,1,2))
related_df <- data.frame(id1 = c(1,2,15), id2 = c(1,1,1), x = c(1,2,3))

setup2 <- setup_test_orphan_rec(primary_df = "df1", related_df = "df2", 
                               primary_key = c("id", "id2"), foreign_key = c("id1", "id2"))

test2 <- test_summary(setup2, primary_df, related_df)
problems2 <- get_problems(setup2, primary_df, related_df)

# Merge tests

merge_tests <- rbind(test1, test2)
merge_problems <- rbind(problems1, problems2)


```